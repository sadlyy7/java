<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ë¸Œë ˆì¸ìŠ¤í† ë° ë³´ë“œ</title>
  <link rel="stylesheet" th:href="@{/css/brain.css}" />
</head>
<body>
  <header>
    <!-- íŒŒì¼ëª…ì´ ì•„ë‹ˆë¼ ë¼ìš°íŠ¸ë¡œ ì´ë™ -->
    <button type="button" onclick="location.href='/main'">Home</button>
    <!-- ë˜ëŠ”: <a class="btn" th:href='@{/main}'>Home</a> -->
    <h1>ë¸Œë ˆì¸ìŠ¤í† ë°</h1>
    <div></div>
  </header>

  <div class="input-area">
    <input type="text" id="ideaInput" placeholder="ì•„ì´ë””ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." />
    <select id="categorySelect">
      <option value="ê¸°ë³¸">ì¹´í…Œê³ ë¦¬ ì„ íƒ</option>
      <option value="ì•„ì´ë””ì–´">ì•„ì´ë””ì–´</option>
      <option value="ë¬¸ì œì ">ë¬¸ì œì </option>
      <option value="í•´ê²°ë°©ì•ˆ">í•´ê²°ë°©ì•ˆ</option>
      <option value="ê¸°íƒ€">ê¸°íƒ€</option>
      <option value="__add__">+ ìƒˆ ì¹´í…Œê³ ë¦¬ ì¶”ê°€</option>
    </select>

    <select id="colorSelect">
      <option value="" selected>ìƒ‰ìƒ ì„ íƒ</option>
      <option value="color-yellow" style="background:#fff3bf;">ë…¸ë‘</option>
      <option value="color-blue"   style="background:#a5d8ff;">íŒŒë‘</option>
      <option value="color-green"  style="background:#b2f2bb;">ì´ˆë¡</option>
      <option value="color-purple" style="background:#d0bfff;">ë³´ë¼</option>
      <option value="color-pink"   style="background:#fcc2d7;">í•‘í¬</option>
      <option value="color-teal"   style="background:#96f2d7;">ë¯¼íŠ¸</option>
    </select>

    <button id="addIdeaBtn">ì¶”ê°€</button>
  </div>

  <div class="category-tabs" id="categoryTabs">
    <div class="tab active" data-category="ì•„ì´ë””ì–´">ì•„ì´ë””ì–´</div>
    <div class="tab" data-category="ë¬¸ì œì ">ë¬¸ì œì </div>
    <div class="tab" data-category="í•´ê²°ë°©ì•ˆ">í•´ê²°ë°©ì•ˆ</div>
    <div class="tab" data-category="ê¸°íƒ€">ê¸°íƒ€</div>
  </div>

  <div class="board-container" id="board"></div>

  <script>
    const board = document.getElementById("board");
    const addBtn = document.getElementById("addIdeaBtn");
    const input = document.getElementById("ideaInput");
    const categorySelect = document.getElementById("categorySelect");
    const tabsContainer = document.getElementById("categoryTabs");
    const colorSelect = document.getElementById("colorSelect");

    let currentCategory = "ì•„ì´ë””ì–´";

    // ìƒ‰ìƒ ì„ íƒ ì‹œ select ë°°ê²½ìƒ‰ ë³€ê²½
    colorSelect.addEventListener("change", () => {
      const selected = colorSelect.options[colorSelect.selectedIndex];
      const bg = selected.style.background || "#fff";
      colorSelect.style.background = bg;
    });
	  
	let spaceId = null;

// â­ íŒ€ IDë¥¼ localStorageì—ì„œ ê°€ì ¸ì˜¤ê¸°
const teamId = localStorage.getItem("selectedTeamId");

if (!teamId) {
  alert("íŒ€ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤! ë©”ì¸ í™”ë©´ì—ì„œ íŒ€ì„ ì„ íƒí•˜ì„¸ìš”.");
  location.href = "/main";
}

// â­ íŒ€ ID ê¸°ë°˜ ê³µê°„ ì´ˆê¸°í™”
async function initBrain() {
  try {
    const res = await fetch(`/api/brainstorm/spaces/spaceId/${teamId}`);
    spaceId = await res.json();

    console.log("ğŸ“Œ teamId:", teamId);
    console.log("ğŸ“Œ spaceId:", spaceId);

    loadIdeas();
  } catch (err) {
    console.error("ì´ˆê¸°í™” ì˜¤ë¥˜:", err);
  }
}

initBrain();

    // íƒ­ í´ë¦­ ì‹œ ì¹´í…Œê³ ë¦¬ ë³€ê²½
    function refreshTabListeners() {
      document.querySelectorAll(".tab").forEach(tab => {
        tab.onclick = () => {
          document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
          tab.classList.add("active");
          currentCategory = tab.dataset.category;
          loadIdeas();
        };
      });
    }
    refreshTabListeners();

    // ìƒˆ ì¹´í…Œê³ ë¦¬ ì¶”ê°€
    categorySelect.addEventListener("change", () => {
      if (categorySelect.value === "__add__") {
        const newCat = prompt("ìƒˆ ì¹´í…Œê³ ë¦¬ ì´ë¦„ ì…ë ¥:");
        if (!newCat) { categorySelect.value = currentCategory; return; }

        const option = document.createElement("option");
        option.value = newCat;
        option.textContent = newCat;
        categorySelect.insertBefore(option, categorySelect.lastElementChild);
        categorySelect.value = newCat;

        const tab = document.createElement("div");
        tab.className = "tab";
        tab.dataset.category = newCat;
        tab.textContent = newCat;
        tabsContainer.appendChild(tab);
        refreshTabListeners();
      }
    });

    /// ì„œë²„ì— ì•„ì´ë””ì–´ ì¶”ê°€
    addBtn.addEventListener("click", addIdea);
    input.addEventListener("keypress", e => { if (e.key === "Enter") addIdea(); });

	function addIdea() {
	  if (!spaceId) return alert("ê³µê°„ ì´ˆê¸°í™” ì¤‘!");

	  const message = input.value.trim();
	  const category = categorySelect.value;
	  let color = colorSelect.value || "color-yellow";

	  if (!message) return alert("ì•„ì´ë””ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”!");
	  if (category === "ê¸°ë³¸") return alert("ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”!");

	  const idea = {
	    spaceId,
	    userId: 100,
	    message,
	    category,
	    color,
	    posX: 200,
	    posY: 200,
	    votes: 0
	  };

	  fetch("/api/brainstorm/messages", {
	    method: "POST",
	    headers: {"Content-Type": "application/json"},
	    body: JSON.stringify(idea)
	  })
	  .then(() => {
	    input.value = "";
	    loadIdeas();
	  })
	  .catch(err => console.error("ì €ì¥ ì˜¤ë¥˜:", err));
	}
    /// ì„œë²„ì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°
	function loadIdeas() {
	  if (!spaceId) return;
	  fetch(`/api/brainstorm/messages/${spaceId}`)
	    .then(res => res.json())
	    .then(data => renderIdeas(data))
	    .catch(err => console.error("ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:", err));
	}


    /// í™”ë©´ ë Œë”ë§ (ì„œë²„ ë°ì´í„° ê¸°ì¤€)
    function renderIdeas(ideas = []) {
      board.innerHTML = "";
      const filtered = ideas.filter(i => i.category === currentCategory);

      filtered.forEach((idea) => {
        const note = document.createElement("div");
        note.className = `sticky-note ${idea.color || "color-yellow"}`;
        note.style.top = `${idea.posY}px`;
        note.style.left = `${idea.posX}px`;
        note.innerHTML = `
          <div>${idea.message}</div>
          <div class="category-tag">#${idea.category}</div>
          <div class="recommend-tab">ì¶”ì²œ ${idea.votes}</div>
          <div class="delete-btn">ì‚­ì œ</div>
        `;

        // ì¶”ì²œ ì¦ê°€
        note.querySelector(".recommend-tab").addEventListener("click", () => {
          idea.votes++;
          updateIdea(idea);
        });

        // ì‚­ì œ ë²„íŠ¼
        note.querySelector(".delete-btn").addEventListener("click", () => {
          deleteIdea(idea.id);
        });

        // ë“œë˜ê·¸ ì´ë™
        makeDraggable(note, idea);

        board.appendChild(note);
      });
    }

    /// ì„œë²„ì—ì„œ ì•„ì´ë””ì–´ ì—…ë°ì´íŠ¸(ì¶”ì²œ+ìœ„ì¹˜)
    function updateIdea(idea) {
      fetch(`/api/brainstorm/messages/${idea.id}`, {
        method: "PUT",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(idea)
      })
      .then(() => loadIdeas())
      .catch(err => console.error("ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:", err));
    }

    /// ì„œë²„ì—ì„œ ì‚­ì œ
    function deleteIdea(id) {
      fetch(`/api/brainstorm/messages/${id}`, {
        method: "DELETE"
      })
      .then(() => loadIdeas())
      .catch(err => console.error("ì‚­ì œ ì˜¤ë¥˜:", err));
    }

    /// ë“œë˜ê·¸ ì´ë™ í›„ ì„œë²„ ì €ì¥
    function makeDraggable(el, idea) {
      let isDragging = false;
      let offsetX, offsetY;

      el.addEventListener("mousedown", (e) => {
        if (e.target.classList.contains("recommend-tab") || e.target.classList.contains("delete-btn")) return;
        isDragging = true;
        offsetX = e.clientX - el.offsetLeft;
        offsetY = e.clientY - el.offsetTop;
        el.style.zIndex = 1000;
      });

      window.addEventListener("mousemove", (e) => {
        if (!isDragging) return;
        el.style.left = `${e.clientX - offsetX}px`;
        el.style.top = `${e.clientY - offsetY}px`;
      });

      window.addEventListener("mouseup", () => {
        if (isDragging) {
          isDragging = false;
          el.style.zIndex = 1;

          idea.posX = el.offsetLeft;
          idea.posY = el.offsetTop;
          updateIdea(idea);
        }
      });
    }

    /// ì²« í™”ë©´ ë¡œë”©
    loadIdeas();
  </script>

</body>
</html>


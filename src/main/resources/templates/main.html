<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ë©”ì¸</title>

    <!-- CSS -->
    <link rel="stylesheet" th:href="@{/css/Main_Css.css}" />
</head>

<body>
    <!-- ğŸ”¥ studentIdëŠ” body ë°”ë¡œ ì•„ë˜!! -->
    <input type="hidden" id="studentId" th:value="${session.student.id}">

    <div class="container">

        <!-- ìƒë‹¨ í—¤ë” -->
        <header class="top-header">
            <div class="header-left">
                <div class="logo">í•„ê¸°</div>
            </div>

            <div class="header-center">
                <p th:text="${session.student != null ? 'í™˜ì˜í•©ë‹ˆë‹¤, ' + session.student.name + 'ë‹˜!' : 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤'}"></p>
            </div>

            <div class="header-right">
                <button id="team-select-btn">íŒ€ ì„ íƒ</button>
            </div>
        </header>

        <!-- íŒ€ ì„ íƒ ëª¨ë‹¬ -->
        <div id="team-modal" class="team-modal hidden">
            <div class="team-modal-content">
                <h3>íŒ€ ì„ íƒ</h3>
                <div id="team-list"></div>
            </div>
        </div>

        <!-- ë„¤ë¹„ê²Œì´ì…˜ -->
        <nav class="link-nav">
            <a href="/note">í•„ê¸°</a>
            <a href="/Memo">í•„ê¸°ëª¨ì•„ë³´ê¸°</a>
            <a th:href="@{/brain}">ë¸Œë ˆì¸ìŠ¤í† ë°</a>
        </nav>

        <!-- ë©”ì¸ 3ë¶„í•  -->
        <main class="dashboard">

            <!-- 1: ë‹¬ë ¥ -->
            <section class="panel calendar-panel">
                <h2>ë‹¬ë ¥</h2>
                <div id="calendar"></div>
            </section>

            <!-- 2: ê³µë¶€ëŸ‰ -->
            <section class="panel stats-panel">
                <div class="stats-header">
                    <h2>ê³µë¶€ ê¸°ë¡</h2>

                    <div class="stats-tabs">
                        <button class="stats-tab active" data-target="timer">íƒ€ì´ë¨¸</button>
                        <button class="stats-tab" data-target="chart">í†µê³„</button>
                    </div>
                </div>

                <div class="stats-content">
                    <!-- íƒ€ì´ë¨¸ -->
                    <div id="stats-timer" class="stats-section active">
                        <div class="timer-section stopwatch-section">
                            <h3>ìŠ¤í„°ë”” íƒ€ì´ë¨¸</h3>

                            <div class="display" id="stopwatch-display">00:00:00</div>

                            <div class="controls">
                                <button class="start" id="stopwatch-toggle">ì‹œì‘</button>
                                <button class="stop" id="stopwatch-save">ì €ì¥</button>
                            </div>

                            <div class="lap-times" id="lap-times"></div>
                        </div>
                    </div>

                    <!-- ì°¨íŠ¸ -->
                    <div id="stats-chart" class="stats-section">
                        <div class="timer-section">
                            <canvas id="studyChart"></canvas>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 3: TODO ë¦¬ìŠ¤íŠ¸ -->
            <section class="panel todo-panel">
                <h2>í•  ì¼ ë¦¬ìŠ¤íŠ¸</h2>

                <ul id="todo-list" class="todo-list"></ul>

                <div class="todo-input-row">
                    <input id="todo-input" placeholder="í•  ì¼ì„ ì…ë ¥í•˜ì„¸ìš”" />
                    <button id="add-todo">ì¶”ê°€</button>
                </div>
            </section>

        </main>

    </div>

    <!-- JS -->
    <script th:src="@{/js/Main_Calender.js}"></script>

    <!-- íƒ­ -->
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            document.querySelectorAll(".stats-tab").forEach(tab => {
                tab.addEventListener("click", () => {
                    document.querySelectorAll(".stats-tab").forEach(t => t.classList.remove("active"));
                    tab.classList.add("active");

                    document.querySelectorAll(".stats-section").forEach(s => s.classList.remove("active"));
                    document.getElementById(`stats-${tab.dataset.target}`).classList.add("active");
                });
            });
        });
    </script>

    <!-- Stopwatch -->
    <script>
        class Stopwatch {
            constructor(display) {
                this.display = display;
                this.interval = null;
                this.startTime = 0;
                this.elapsedTime = 0;
                this.Running = false;
            }

            toggle() {
                if (!this.Running) {
                    this.start();
                    document.getElementById("stopwatch-toggle").textContent = "ë©ˆì¶¤";
                } else {
                    this.stop();
                    document.getElementById("stopwatch-toggle").textContent = "ì‹œì‘";
                }
            }

            start() {
                this.Running = true;
                this.startTime = Date.now() - this.elapsedTime;
                this.interval = setInterval(() => this.updateDisplay(), 10);
            }

            stop() {
                clearInterval(this.interval);
                this.elapsedTime = Date.now() - this.startTime;
                this.Running = false;
            }

            reset() {
                this.stop();
                this.elapsedTime = 0;
                this.updateDisplay();
                document.getElementById("stopwatch-toggle").textContent = "ì‹œì‘";
            }

            saveToDB() {
                const duration = this.formatTime(this.elapsedTime);

                return fetch("/timer/save", {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({
                        timestamp: new Date().toISOString(),
                        duration: duration,
                        userId: 1,
                        timerId: 1
                    })
                })
                .then(res => res.json())
                .then(data => {
                    alert("ì €ì¥ ì™„ë£Œ! ì˜¤ëŠ˜ ì´ ê³µë¶€ì‹œê°„: " + data.totalDuration);
                    return data;
                })
                .catch(err => console.error("ì €ì¥ ì‹¤íŒ¨", err));
            }

            updateDisplay() {
                const time = this.Running ? Date.now() - this.startTime : this.elapsedTime;
                this.display.textContent = this.formatTime(time);
            }

            formatTime(ms) {
                const h = Math.floor(ms / 3600000);
                const m = Math.floor((ms % 3600000) / 60000);
                const s = Math.floor((ms % 60000) / 1000);
                return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
            }
        }

        document.addEventListener("DOMContentLoaded", () => {
            const stopwatch = new Stopwatch(document.getElementById("stopwatch-display"));

            document.getElementById("stopwatch-toggle")
                .addEventListener("click", () => stopwatch.toggle());

            document.getElementById("stopwatch-save")
                .addEventListener("click", () => {
                    stopwatch.stop();
                    stopwatch.saveToDB().then(() => stopwatch.reset());
                });
        });
    </script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const ctx = document.getElementById('studyChart');
            let studyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† ','ì¼'],
                    datasets: [{
                        label: 'ê³µë¶€ì‹œê°„(ì‹œê°„)',
                        data: [0,0,0,0,0,0,0],
                        borderColor: 'blue',
                        backgroundColor: 'rgba(0,0,255,0.2)'
                    }]
                },
                options: {
                    responsive: true,
                    scales: { y: { beginAtZero: true } }
                }
            });
        });
    </script>

</body>
</html>
